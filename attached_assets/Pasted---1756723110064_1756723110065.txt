※お願い：下記を全部実装し、最後の「受け入れ確認」をすべて合格してから完了報告してください。部分対応の中間報告は不要です。代替案がある場合も、全体整合が取れる形で提示し、受け入れ確認を全合格させてください。

指示：出荷指示後の表示遷移と履歴不整合を完全修正する
症状（共有）

出荷指示を作成しても、少数アラート側からカードが消えず、「処理中の出荷指示」に移動しない。画面更新でも残る。

履歴に 「棚A → 棚A」 のような無意味な在庫移動が記録される（店舗6で出荷指示を作っても、倉庫→店舗ではなく棚A→棚Aになっている）。

一方で、ダッシュボードや入出庫の件数は更新され、出荷確定すると指標は正しく減る。

修正方針（サーバ／フロント両面）
優先度1（仕様の正化：出荷指示では在庫を動かさない）

出荷指示の作成＝“予約レコード”のみ

出荷指示作成時は在庫残高を一切変更しない。

inventory_history にも在庫移動の行は書かない。代わりに、履歴はタイプ「出荷指示作成」の情報行として記録（from/to/locationはnull）。

在庫を動かすのは倉庫で「出荷確定」した時点のみ（倉庫↓／店舗↑／履歴1行「出荷確定」）。

「棚A→棚A」記録の禁止

出荷指示作成ハンドラ内に在庫移動ロジックやダミーfrom/to設定が混入していないかを除去。

バリデーション：履歴を在庫移動タイプで登録する際、fromLocationId ≠ toLocationId を必須にする（同一なら拒否）。

優先度2（一覧の正化：少数アラート⇔処理中の出荷指示の切替）

少数アラートの表示ルールを変更

対象店舗（例：店舗6）のSKU×店舗で、以下の条件を満たす行だけを「少数アラート」に出す：

現在庫（通常） < 下限 かつ そのSKU×店舗に “未完了の出荷指示（status=pending）” が存在しない


つまり、そのSKU×店舗に未完了の出荷指示が1件でもあれば、「少数アラート」からは除外し、**「処理中の出荷指示」**側に出す。

さらに余力があれば、少数アラート内の各行に requestedQty を考慮して 不足残量 = max(0, 下限 - (現在庫 + requestedQty)) を表示（任意）。

「処理中の出荷指示」リストの定義

対象店舗の status=pending の出荷指示を、期限昇順で表示。

列例：SKU / 数量 / 希望日 / 作成日時 / 状態。

倉庫で出荷確定したら即座に完了へ移動（下記の無効化・再取得で反映）。

APIの観点

/api/shipping/shortage?storeId=...：上記の除外条件を盛り込んだ結果を返す（LEFT JOINでpending有無を判定）。

/api/shipping/pending?storeId=...：対象店舗の未完了出荷指示を返す。

どちらも**件数（total）**を返し、UIのバッジに反映できるようにする。

優先度3（UIの正化：作成直後の移動＆再取得）

出荷指示作成後の画面更新

作成成功時に、以下を必ず再取得（あるいは確実な楽観更新）：

shipping/shortage?storeId=...（少数アラート）

shipping/pending?storeId=...（処理中の出荷指示）

ダッシュボードの未処理出荷指示件数

通知バッジ（未処理合計）

右サイド履歴（トップに「出荷指示作成」）

楽観更新をする場合も、最終的にAPI再取得で整合を取る。

カードの移動が目で分かるUI（任意だが推奨）

作成直後に、対象行を少数アラートから消去→右の「処理中の出荷指示」リストの先頭にフェードイン。

優先度4（出荷確定時の在庫移動を厳密化）

倉庫での「出荷確定」

在庫移動は、倉庫（通常 または 確保）→ 店舗（通常）。

inventory_history の1行に fromLocation=倉庫棚 / toLocation=店舗（仮想ロケーション） / qty / performedBy を記録。

出荷確定に成功したら、pending → completed に遷移。

完了後は、ダッシュボードKPI／通知／処理中リストを再取得。

受け入れ確認（すべて合格してから完了報告）

出荷指示作成直後の挙動

画面を更新せずとも、当該SKUのカードが少数アラートから消え、右側の「処理中の出荷指示」に追加される。

右サイド履歴の先頭に 「出荷指示作成」 が出るが、在庫移動の履歴は出ない。

在庫移動の記録

出荷指示作成時：inventory_history に在庫移動行が作成されない（from/to は null の情報行のみ、または履歴非作成でも可）。

出荷確定時：inventory_history に 倉庫棚 → 店舗 の正しい行が1件記録される（棚A→棚A のような同一ロケーション行は出ない）。

ダッシュボード・通知の連動

出荷指示作成でダッシュボードの未処理件数と通知バッジが増加。

出荷確定で減少。少数アラートは在庫が基準以上になれば自動的に消える。

再取得の確実性

作成／確定のたびに、少数アラート・処理中リスト・通知・KPI・履歴が確実に更新される（キャッシュ無効化 or 再fetch）。

多重作成の抑止（任意だが推奨）

同一SKU×店舗にpending が存在する間、当該SKUの少数アラートカードは再表示されない（二重指示の防止）。