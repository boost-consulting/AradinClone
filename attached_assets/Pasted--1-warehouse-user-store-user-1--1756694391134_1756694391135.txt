修正指示（最終版・自然言語のみ）
優先度1（ブロッカー／整合性の確保）

ユーザーと認証の前提を固定

デモ用ユーザー（例：warehouse_user / store_user_1…）を必ずシードし、すべての書込みAPIで performedBy / createdBy に実在IDが入る状態にする。

セッション認証（自動ログインでも可）後に、全ての書込み系が通ること。

在庫更新の“数量は常に正の値”を全APIで統一（最優先）

返品（店舗→倉庫返品送付）の数量符号を統一：

Returns画面の「店舗→倉庫返品送付」は正の数量で店舗側の減算のみ行う（fromState="通常"、toStateは未指定）。

倉庫側の受入は入出庫画面で別途処理し、toState="検品中" で加算する（二段処理）。

サーバのバリデーションは quantity を正の値のまま、toState を省略可（optional）にして減算のみの呼び出しを許容する。

以後、負の数量を送る実装を全面廃止（販売・返品送付含む）。

販売は“減算のみ”（fromState="通常"、toStateなし）で統一。

ナビゲーションを確実に機能させる

ダッシュボード上段カード／下段クイックアクション：それぞれ該当画面へ遷移できること。

通知バッジはクリックで未処理出荷指示の簡易一覧を開き、行クリックで入出庫（出荷処理タブ）に遷移。

セレクトと空状態の堅牢化

すべてのセレクトの value は非空の定数（例："all"）。"" や undefined は使用しない。

どの表・カード・リストも空でも崩れず「該当データがありません」を表示。KPIは0安全表示。

在庫更新は“1操作＝一体更新＋履歴1行”を厳守

例：出荷確定＝倉庫（通常/確保）減→店舗（通常）増→指示=完了→履歴1行。

例：受入→棚入れ＝検品中へ加算→確定で通常/不良へ振替→履歴1行。

優先度2（データと表示の正しさ）

シードを冪等化（または明示リセット→再投入）

同じシードを複数回実行しても重複が増えない方式にする（Upsert）、またはリセット→再投入を実行。

実行手順：ユーザー投入 → その後に他データのシード。READMEにも明記。

一意制約で構造的重複を物理的に禁止

商品：SKU一意。場所：場所コード一意。補充基準：(SKU, 場所) 複合一意。

在庫残高（設計に応じて）：(SKU, 場所) 一意（状態は列）／または (SKU, 場所, 状態) 一意（状態別行）。

ユーザー：ユーザーID一意。出荷指示：アプリ内ID（連番/UUID）一意。

既存の重複データをクリーンアップ

同名の場所は1件に統合、在庫残高は同一キーを集計して1行に、補充基準は最新値を残す。

二重出荷指示は古い方をキャンセル扱いで非表示。

履歴の同一タイムスタンプ連続二重は片方に無効フラグ。

ダッシュボードKPI／一覧をDB集計に接続

上段：未処理出荷指示件数／本日の受入（予定・処理）／在庫少数アラート件数／直近7日の販売点数。

下段：未処理出荷指示一覧／少数アラート詳細。

書込み後は再取得または軽ポーリングで数値が動くこと。

在庫少数アラートの件数肥大を抑制

判定は**SKU×場所の“通常在庫” vs “下限在庫”**で重複が出ない集計にする（JOINでの多重化を回避／GROUP BY + DISTINCT）。

倉庫棚がA/B/Cでも、ダッシュボード表示は倉庫内合算で1件扱い。

表示は上位50件に抑え、総件数は別表示（例：「1500件中の上位50件」）。

並び順は不足数量または不足率降順。店舗ロールは自店舗限定表示。

シードのSKU数の整合性

いま実挿入は30SKU。

方針：30SKUで運用するか、72SKUに増やすかを決め、実データと表示文言を一致させる（sliceを外すか、文言を「30SKU」に修正）。

優先度3（画面／UX・一連の業務を完成）

右サイド「直近の履歴」を画面文脈で切替

ルート/タブに応じて types= などのパラメータで絞り込み、ページ遷移で再取得されること。

表示用の操作種別は統一語（例：「棚入れ」）。

在庫一覧の「明細」モーダル

クリックで**SKU×場所の履歴（最新20件）**が必ず出る。空なら空文言。

入出庫（出荷処理／受入／返品検品）の“通し”

出荷処理：未処理→（任意で確保）→出荷確定（倉庫↓／店舗↑／指示=完了／履歴1行）。不足時は明確なエラー文言。

受入→棚入れ：検品中へ加算 → 確定で通常 or 不良へ。

返品受入・検品：店舗送付分の検品中を受入 → 再販可=通常／不可=不良へ確定。

販売管理の体験改善

初期店舗をデフォルト選択（例：店舗1）にして、開いた直後から在庫サマリが出るように。

在庫サマリ（当該店舗の通常/不良）からSKUクリックで販売フォームへ反映。登録後は在庫↓／販売履歴（売上金額付）。

出荷指示（店舗）

左：少数アラート（自店舗のみ）。行クリックで**SKUと推奨数量（max(0, 基準−現在庫))**をフォームに自動入力。

中：未処理の出荷指示（受付中）。右：完了済み（最新20件）。

作成後は未処理が増え、ダッシュボードの件数も増える。

返品管理（店舗）

顧客返品：再販可→店舗・通常＋／不良→店舗・不良＋。

店舗→倉庫返品送付：店舗・通常−（正の数量・減算のみ）。倉庫側の到着は入出庫で検品中＋。

店舗セレクタの一貫性

ヘッダーの選択が販売／出荷指示／返品の初期値に反映されること。店舗ロール時は固定。

場所セレクタ／一覧の“重複見え”対策

UI上はdistinct化し、コード順表示。ラベルに場所コードをサブ表示して識別性を上げる。

優先度4（安定運用・メンテのための仕上げ）

通知バッジの体験を完成

バッジ＝未処理出荷指示件数。クリックでドロップダウン一覧→行クリックで入出庫へ。未件時は明示メッセージ。

デモデータ“再作成”ボタン（管理専用）

リセット→シードを1クリックで実行（確認モーダルあり）。本番ガード付き。

起動時の健全性チェック

重複検出時は警告ログ。UIに黄色バナーで「データ整合性に問題、再作成推奨」を表示できるオプション。

入力バリデーションの徹底

数量は0以上の整数、在庫減算は残を下回らない。

エラーは項目下＋ページ上部要約で明快に。

用語の完全統一

UI／履歴とも同一表記（例：「棚入れ」）。色分け・アイコンも同ルールで。

受け入れ確認（必ずこの順で実操作し、全合格）

ログイン → シード（ユーザー→全データ）。

シードを2回実行しても重複が増えない（またはリセット方式で再現性あり）。

ダッシュボード

KPIと一覧が実データで埋まり、カード／クイックアクション／通知ドロップダウンから正しく遷移できる。

少数アラートは現実的な件数（上位50件表示＋総件数）で、自店舗限定が有効。

出荷指示作成（店舗）

少数アラート行→フォームにSKU・推奨数量が入る→作成→未処理が増える。

出荷確定（倉庫）

倉庫在庫↓・店舗在庫↑・指示=完了・履歴1行。不足時は明確エラー。

販売登録（店舗）

初期店舗が選択済みで在庫サマリが表示。SKUクリック→登録→在庫↓／販売履歴（売上付）。

顧客返品（店舗）

再販可→店舗・通常＋／不良→店舗・不良＋。

店舗→倉庫返品送付 → 倉庫で検品

送付は正の数量・減算のみで通る。入出庫で検品中＋→検品確定で通常 or 不良＋。

在庫一覧「明細」

SKU×場所の履歴20件がモーダルで表示（空なら空表示）。

重複再発なし

場所・在庫残高・補充基準に二重行が増えない。

「店舗1が複数」「アラートが異常件数」など見た目の不信感が再発しない。

備考（見映え調整）

SKU数は現状30SKUでデモ十分。72SKUにするなら文言も含めて統一してください。

初期店舗は“店舗1”を既定選択にして、開いてすぐ販売できる体験にしてください。
