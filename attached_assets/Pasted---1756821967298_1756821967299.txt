お願い：下記をすべて実装し、最後の受け入れ確認が全て○になってから完了報告してください。部分対応の中間報告は不要です。代替案がある場合も、全体整合と受け入れ確認の全合格を満たす提案でお願いします。

指示（ブロッカー解消の完全版）
優先度1：作業モード切替の復旧（403の根絶）
1-1. デモ用の「権限切替」方式に変更

現在の /api/auth/switch が、**“今のユーザーが指定店舗の権限を持つか”**を検査して403にしているため、デモでは禁止。

仕様変更：/api/auth/switch は認証済みであれば誰でも、指定のモードにインパーソネートできるようにする（＝デモ環境に限り、認可チェックを外す）。

mode:'warehouse' → セッションを 倉庫ユーザー に切替（userId=warehouse_user、role='WAREHOUSE'、storeId=null）

mode:'store', storeId:n → セッションを 店舗nユーザー に切替（userId=store_user_n、role='STORE'、storeId=n）

既にユーザー行がなければ、初回呼び出し時に自動作成でもOK（デモ仕様）。

ねらい：UIのモードとサーバのrole/storeIdを常に一致させ、403による“ねじれ”をなくす。

1-2. セッションの「真値」を返すAPI

GET /api/auth/me を必ず用意し、{ role, storeId, userId } を返す。

フロントはこの値を唯一の真実として使い、活性/非活性を判定する。

1-3. フロントの切替手順（固定化）

ヘッダーでモード選択 →

POST /api/auth/switch（credentials:'include' 必須）

直後に GET /api/auth/me を再取得し、UI状態を同期

以下を invalidate→再fetch：ダッシュボードKPI／未処理出荷／未処理仕入予定／在庫／通知／右サイド履歴

切替中は全アクション非活性＋スピナー。

ヘッダー右上に 作業モード：倉庫｜店舗n（server role=…, storeId=…） の小さな表示（開発用）を出す。

これで、切替成功＝即座にボタン活性が切替ることを可視化できる。

優先度2：出荷ワークフローの再稼働
2-1. 能力判定の一本化（全画面共通）

role==='WAREHOUSE' → 出荷確定 OK（「出荷処理」ボタン活性）

role==='STORE' → 出荷指示作成 OK（「出荷指示を作成」活性）

同じ関数を入出庫上段左パネルと下段［出荷処理］フォームの両方で使う。

店舗ロール時に確定ボタンは非活性＋鍵アイコン＋ツールチップ（「倉庫モードでのみ確定できます」）。

2-2. サーバ側の許可／禁止

POST /shipping/requests：STOREのみ許可（出荷指示の新規作成）

POST /shipping/confirm：WAREHOUSEのみ許可（倉庫→店舗への在庫移動＋指示の状態更新）

同一ロケーション（棚A→棚A）禁止。履歴は在庫移動1行＋出荷指示のステータス更新。

2-3. 行→フォームのプリセット厳守

上段左の「出荷処理」行クリック → 下段［出荷処理］タブへ自動遷移し、店舗／SKU／数量をプリセット。

プリセット値は単一のstateに保持→そのstateからAPIに送る（hidden stateの二重管理は禁止）。

優先度3：未処理仕入予定（ダッシュボードと完全連動）
3-1. ダミーデータ（起動直後から「ある」状態に）

inbound_plans に本日5件、+1日5件、+3日5件をシード（計15件）。

planned_qty=10、received_qty=0、status='pending'、supplier='デフォルト仕入先'

冪等：同一キー（sku+due_date+「demo」）が既にあれば挿入しない。

3-2. 「母数＝右パネル」を単一WHERE句で揃える

共通関数：status in ('pending','partially_received') AND due_date=今日（TZ固定：例 Asia/Tokyo）

ダッシュボードの「本日の仕入受入（予定）」と、入出庫右パネル GET /api/inbounds/pending?range=today は必ずこの関数で集計／抽出。

カード→入出庫の遷移で、右パネルは range=today に強制＆即fetch。

3-3. 自動補充（在庫低下トリガ）

POST /api/inbounds/replenish?date=today：倉庫の通常在庫 < target で、未処理planが無ければ当日分のplanを新規作成（冪等）。

自動トリガ：出荷確定（必須）、（必要なら販売/返品で倉庫在庫が減る場合）。

成功後は 右パネル＆ダッシュボードを invalidate→再fetch。

優先度4：再取得・通知・履歴（ねじれ防止の仕上げ）

書込み成功後に必ず再fetch：ダッシュボード／未処理出荷／未処理仕入／在庫／通知／右サイド履歴

排他ルール：SKU×店舗に pending 出荷指示がある間は、少数アラートに出さない（SQLで除外）。

タイムゾーンをサーバ/フロントで統一し、due_date=今日 の判定ブレを根絶。

エラーメッセージの改善（すぐ分かるように）

モード切替失敗（今回の403のようなケース）：

トースト：作業モード切替に失敗（サーバ403）- デモではインパーソネートを許可してください

権限不足：

トースト：この操作は倉庫モードでのみ実行できます（または店舗モードのみ）

ボタン：非活性＋鍵アイコン＋ツールチップ

ヘッダーにserver role/storeId を小さく表示（開発中のみで可）。

受け入れ確認（完了前に必ず全○）

作業モード切替（403が出ない）

ヘッダー「倉庫」を選択 → /api/auth/switch 成功 → /api/auth/me で role=WAREHOUSE。

すべての主要カード・ボタンの活性が即切替。

「店舗1〜6」に切替 → role=STORE, storeId=n を返し、403は一切発生しない。

出荷ワークフロー

店舗モードで出荷指示を作成 → 倉庫モードに切替 → 入出庫上段左に処理中の出荷指示として表示。

行「出荷処理」→下段［出荷処理］にプリセット→確定成功（403なし）。

同一棚→同一棚の誤移動はサーバで拒否される。

仕入予定の表示と連動

起動直後、ダッシュボードの「本日の仕入受入（予定）」が**>0**、入出庫右パネル（today）も同件数を表示。

カードクリックで入出庫へ遷移すると、同じリストが表示される。

在庫低下→自動補充

倉庫で出荷確定後、自動で仕入予定が増加し、右パネルとダッシュボードが再取得で更新される。

排他ルール

pending の出荷指示があるSKU×店舗は、少数アラートに表示されない。出荷確定で不足が解消されれば表示されない。

うまくいかない時の即時チェック

/api/auth/switch のサーバ実装が“認可チェックなし（デモ）”になっているか。

/api/auth/me の返り値がヘッダー表示と一致しているか。

フロントfetchが credentials:'include' になっているか。

inbound_plans に本日分のpendingが存在するか（TZズレなし）。

react-queryのキーに role/storeId/range を含め、切替時に確実に再fetchされるか。