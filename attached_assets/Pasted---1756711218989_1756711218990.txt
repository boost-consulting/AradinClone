※お願い：下記の全項目を実装し、最後の「受け入れ確認」を全て合格してから「完了報告」をお願いします。一部だけ対応しての中間報告は不要です。代替案がある場合は、全体整合が取れる形で提示し、受け入れ確認をすべて通してください。

修正指示（最終・コピペ用）
優先度1（今すぐ止める／動かす）

Shipping / Sales のクラッシュ修正（TDZ）

症状：Cannot access 'locations' before initialization。

指示：各ページでhooksの宣言順を整理し、locations を 最初に取得→その後に useEffect を定義する。依存配列は locations?.data と selectedStore に限定し、未取得時はガードして実行。必要なら一旦 selectedStore のみの依存でも良い（再取得は操作トリガ）。

デモデータ作成の 403（権限）を解消

指示：デモデータ再作成（リセット→シード）はadmin ロールのみ可。UI上もadmin以外にはボタン非表示。

開発環境では「adminでログイン→実行」の手順を固定（自動昇格は本番無効）。

数量のルールを全APIで統一（常に“正の値”）

指示：返品（店舗→倉庫）は 正の数量・店舗側は減算のみ（fromState="通常", toState 未指定）。倉庫側の到着は入出庫で toState="検品中" 加算（二段処理）。

toState は optional のまま。負の数量送信は全面廃止。

販売は 減算のみ（fromState="通常"／toStateなし）。

在庫更新＝一体更新＋履歴1行（全操作で厳守）

出荷確定／受入→棚入れ／販売／顧客返品／店舗→倉庫返品送付／返品受入・検品のすべてで、在庫更新と履歴追記を必ず一体で実行。

優先度2（データと表示の正しさ）

シードの運用を確定（冪等 or リセット→再投入）

指示：同じシードを複数回叩いても重複が増えない運用に。推奨は「対象テーブルをtruncate→再投入」。

手順は「ユーザー（admin/warehouse/store）投入 → その後に全データのシード」。UIの「デモデータ再作成」はこの順で実行。

一意制約を再確認（重複の物理防止）

products.sku 一意、locations.code 一意、inventory_balances (productId, locationId, state) 複合一意、replenishment_criteria (productId, locationId) 複合一意。

UIのセレクタはdistinct＋コード順で表示（「店舗1が複数」に見えないように）。

ダッシュボードKPI／一覧を実データに完全接続

KPI：未処理出荷指示／本日の受入（当日0:00〜）／在庫少数件数／直近7日販売点数。

書込み後は再取得または軽ポーリングで反映。

在庫少数の判定は SKU×場所の“通常在庫” vs 下限 を基準に、GROUP BY/DISTINCT で多重化を排除。

倉庫棚A/B/Cは倉庫内で合算表示、一覧は上位50件表示＋総件数。店舗ロールは自店舗限定。

直近の履歴：シード投入 & 文脈切替の維持

シードで履歴も投入（受入/棚入れ/出荷確定/販売/顧客返品/返品送付/返品受入・検品）。

サイドバーはルート／タブに応じて types パラメータで絞り込み、ページ遷移で再取得。

優先度3（在庫一覧の使い勝手）

「少数アラートのみ」フィルタを確実に効かせる

APIで isLow（currentNormal < lowerLimit） を返す。合わせて lowerLimit / target / shortageQty / shortageRate も返却。

フロントのトグルは isLow で即フィルタ。id型は文字列に統一して比較事故を避ける。

在庫一覧に不足関連の列を追加

列：下限／基準／不足数／不足率／不足フラグ（●）。

行クリックで出荷指示作成に遷移し、SKUと推奨数量（max(0, 基準−現在庫)) をプリセット。

優先度4（UXの仕上げ／再発防止）

販売管理の初期店舗選択をidで統一

stateはidを保持（ラベルは表示専用）。初期値は最初の店舗のidか all を強制選択。

これで「開いてすぐ在庫サマリ表示→販売登録」が通る。

通知バッジの体験を完成

未処理出荷指示の件数を表示。クリックでドロップダウン一覧→行クリックで入出庫（出荷処理タブ）へ。未件時は明示メッセージ。

受け入れ確認（この順で全合格してから完了報告）

adminでログイン → デモデータ再作成（リセット→シード）。同操作を2回行っても重複が増えない。

ダッシュボード：KPI／一覧に実データが表示され、カード／クイックアクション／通知ドロップダウンの遷移がすべて動く。

出荷指示（店舗）：少数アラート行クリック→フォームに SKU／推奨数量 自動入力→作成→未処理件数が増加。

出荷確定（倉庫）：倉庫在庫↓・店舗在庫↑・指示=完了・履歴1行。在庫不足時は明快なエラー。

販売（店舗）：初期店舗がidで選択済み→在庫サマリ表示→SKUクリック→販売登録→在庫↓／販売履歴（売上付）。

返品（店舗→倉庫）：正の数量・減算のみで店舗在庫が減る。入出庫で検品中＋→検品確定で通常 or 不良＋。

在庫一覧：「少数アラートのみ」トグルで不足だけに絞れる。不足列が表示され、行クリックで出荷指示作成に遷移・プリセットされる。

直近の履歴：ページごとに内容が切り替わり、シード直後から履歴が見える。

重複の再発なし：場所・在庫・補充基準に二重行が増えない／「店舗1が複数」や過大な少数アラートが出ない。

以上です。全項目の実装と上記受け入れ確認の全合格後に「完了報告」をお願いします。