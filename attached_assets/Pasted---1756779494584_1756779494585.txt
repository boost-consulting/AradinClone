お願い：下記の全項目を実装し、最後の「受け入れ確認」まで全て合格してから完了報告をください。部分対応の中間報告は不要です。代替案がある場合も、全体整合が取れる形で提示し、受け入れ確認を全合格させてください。

指示（最終版）：

① ライトRBAC＋ヘッダー「作業モード」切替 と ② 入出庫上段の「未処理出荷」「未処理仕入」並列パネル を同時に実装し、ダッシュボード／通知／履歴と一貫して連動させる

0. 前提と原則（既存仕様の継承）

画面は共通のまま。操作できるボタンだけ役割で制御する（閲覧は全員可）。

出荷指示は在庫を動かさない（予約のみ）。在庫が動くのは**倉庫側の「出荷確定／仕入受入／返品検品」**だけ。

数量は常に正の値で扱う（負数送信は禁止）。

入出庫画面の下段は既存のタブ式フォームを維持：
[出荷処理]｜[仕入受入]｜[返品受入・検品]

「仕入受入の未処理予定」のデータソースは inbound_plans（pending / partially_received）を用いる。

1. ライトRBAC＋ヘッダー「作業モード」切替
1-1. 役割

STORE（店舗：店舗1〜店舗6）

WAREHOUSE（倉庫）

1-2. 許可（閲覧は全員可、操作だけ制御）
機能	STORE	WAREHOUSE
ダッシュボード・在庫一覧・履歴・通知の閲覧	○	○
出荷指示の作成（店舗→倉庫へ依頼）	○	―（表示のみ）
販売登録（店頭販売）	○	―（非活性）
顧客返品（店頭在庫に戻す）	○	―（非活性）
店舗→倉庫返品送付（店舗在庫の減算のみ）	○	―（非活性）
出荷確定（倉庫在庫↓→店舗在庫↑）	―（非活性）	○
仕入受入（良品/不良の加算）	―（非活性）	○
返品受入・検品（検品中→通常/不良）	―（非活性）	○
1-3. ヘッダーUI（作業モード）

右上ユーザードロップダウンに**「作業モード」**を追加：倉庫 / 店舗1〜店舗6。

選択中モードをヘッダーにバッジ表示（例：倉庫 / 店舗6）。

店舗モード：対象店舗は自店舗に固定。店頭系（販売・顧客返品・店舗→倉庫返品・出荷指示作成）は活性／入出庫の確定系は非活性＋鍵アイコン＋ツールチップ。

倉庫モード：入出庫の確定系が活性／店頭系は非活性＋ツールチップ。

モードはセッション or ローカルストレージで保持し、再訪時に復元。

通知ドロップダウンは全員閲覧可。店舗モードで「出荷確定」系行を押したら倉庫へ切替の促し→1クリックで切替→該当タブに遷移。

1-4. サーバ最小ガード（誤操作防止）

POST /shipping/requests → STOREのみ

POST /shipping/confirm → WAREHOUSEのみ

POST /inbounds/receive → WAREHOUSEのみ

POST /returns/inspect → WAREHOUSEのみ

POST /sales / POST /returns/customer / POST /returns/send_to_warehouse → STOREのみ

返却は403。フロントはトーストで理由表示。

デモ便宜上、.env の DEMO_SKIP_AUTH=false（trueならサーバガード緩和、基本はfalse）。

1-5. シード

既存の店舗ユーザーは存続。**倉庫ユーザー（WAREHOUSE）**を1件シードしログイン可能に。

セッションに role と必要なら storeId を含め、フロントの ability 初期化に使用。

2. 入出庫画面：上段に「未処理出荷」「未処理仕入」を並列配置
2-1. 上段「未処理一覧」エリア（2カラム）

レイアウト：デスクトップは 50%/50%、狭幅は縦スタック。

左：未処理出荷指示

ヘッダー：未処理 n件 バッジ＋クイックフィルタ（期限切れのみ / 本日 / 7日間 / すべて、SKU/店舗検索）。

列：店舗 / SKU / 数量 / 希望日 / 状態 / 操作。

行操作：**「出荷処理」で下段[出荷処理]**タブに自動遷移し、店舗/SKU/数量をプリセット。

右：未処理仕入予定

ヘッダー：未処理 n件 バッジ＋クイックフィルタ（期限切れ含む / 本日 / 7日間 / すべて、SKU/仕入先検索）。

列：仕入先 / SKU / 残量 / 期限 / 状態 / 操作。

行操作：**「受入処理」で下段[仕入受入]**タブに自動遷移し、仕入先/SKU/推奨数量=残量をプリセット。

空状態：左「未処理の出荷指示はありません」／右「未処理の仕入予定はありません」。

2-2. 下段「処理フォーム」エリア（既存＋自動プリセット）

[出荷処理]：倉庫↓ → 店舗↑ → 指示=完了 → 履歴1行（出荷確定）。

[仕入受入]：通常/不良に加算 → received_qty 更新 → 残量0で completed → 履歴1行（仕入受入・予定対応）。

[返品受入・検品]：検品中→通常/不良へ確定（現状踏襲）。

3. 少数アラートと「処理中の出荷指示」の排他表示ルール

「少数アラート」に出すのは、対象店舗の SKU×店舗で
現在庫（通常） < 下限 かつ status=pending の出荷指示が存在しない 行のみ。

同SKU×店舗に pending が1件でもあれば、少数アラートからは除外し、**「処理中の出荷指示」**に表示。

参考：不足残量を見せる場合は 不足残量 = max(0, 下限 - (現在庫 + requestedQty合計))。

4. API / データ（必要最小限）
4-1. 仕入予定（新規 or 既存拡張）

テーブル inbound_plans

id / product_id / supplier_name / planned_qty / received_qty / due_date / status(pending|completed|canceled) / memo / created_by / created_at

制約：planned_qty >= received_qty。残量=planned - received、残量0→completed。

GET /api/inbounds/pending

range=today|7d|all、include_overdue=true|false、q、limit

返却：id, sku, productName, supplier, dueDate, plannedQty, receivedQty, remainingQty, status

POST /api/inbounds/receive

入力：plan_id, date, good_qty, defect_qty, shelf_id, memo（数量は正の値）

挙動：在庫加算（通常/不良）→ received_qty 更新 → 残量0でcompleted → inventory_history に1行（種別：仕入受入・予定対応）

4-2. 出荷関連

GET /api/shipping/pending?storeId=...：対象店舗の pending を期限昇順で返す（検索/期間フィルタ対応）。

GET /api/shipping/shortage?storeId=...：上記排他ルールを適用した少数アラートリストを返す（LEFT JOINでpending有無判定）。

POST /api/shipping/requests：予約のみ（在庫は動かさない）。履歴は**情報行「出荷指示作成」**として記録（在庫移動行は記録しない）。

POST /api/shipping/confirm：倉庫在庫↓ → 店舗在庫↑、履歴1行「出荷確定」（from=倉庫棚、to=店舗）。同一ロケーション(from=to)は禁止。

5. ダッシュボード・通知・履歴の連動

ダッシュボード上段KPI（未処理出荷指示／本日の仕入受入／在庫少数／直近7日販売）は、作成／確定／受入の直後に再取得して変化を反映。

通知（ベル）は2セクション：未処理出荷指示／未処理仕入予定（各最新10件）。行クリックで入出庫に遷移し、該当パネルをハイライト、下段タブも自動選択。

右サイド「直近の履歴」は画面文脈で絞り込み、作成・確定・受入のたびに先頭に追加。

6. バリデーション（フロント／サーバ）

すべての数量は正の整数。

出荷指示の requestedDate は YYYY-MM-DD（ISO日付）or null を受け付ける。文字列のままでもサーバ側で正規化し保存。

仕入受入は good_qty + defect_qty <= remainingQty をサーバで強制。

在庫移動履歴は fromLocationId ≠ toLocationId を必須（同一ロケーションの記録は禁止）。

7. 受け入れ確認（すべて○で完了）

モード切替：右上から 店舗6 ↔ 倉庫 を切替。バッジ・ボタン活性が即時切替。

ダッシュボード導線：

「未処理出荷指示」カード→入出庫→**左パネルが“本日”**で並ぶ。

「本日の仕入受入」カード→入出庫→**右パネルが“本日”**で並ぶ。

出荷指示作成直後：

少数アラートの当該SKUが消え、右の「処理中の出荷指示」に移動（画面更新不要）。

右サイド履歴の先頭に**「出荷指示作成」（在庫移動行は出ない**）。

KPI／通知バッジが増える。

出荷確定（倉庫モード）：

倉庫↓・店舗↑・pending→completed・履歴1行（倉庫→店舗）。

KPI／通知／左・右パネルが即更新。

仕入受入：

右パネルからプリセット→登録で通常/不良＋、received_qty 更新。残量0でcompleted、右パネルから消える。履歴に1行。

通知ドロップダウン：

2セクション併記。店舗モードで「出荷確定」を押すと**倉庫へ切替の促し→ワンクリック切替→入出庫（出荷処理タブ）**に到達。

回帰防止：

「棚A→棚A」のような同一ロケーション履歴が記録されない。

少数アラート⇔処理中の切替が常に正しく機能（pending 存在中はアラートに出ない）。

権限ガード：

非活性を無理押ししてもサーバが403で拒否。トーストで理由表示。

補足（実装を軽くする工夫）

予定は「1行=1SKU」で表現（多品目は複数行）。

在庫更新・履歴追記は共通関数を再利用。

react-query 等のキャッシュは、作業モード・店舗・日付レンジをキーに含め、作成／確定／受入の直後に無効化→再取得。

以上です。ライトRBAC＋作業モードで誤操作を防ぎつつ、入出庫上段の並列パネルで「未処理→処理」の動線を短縮し、ダッシュボード／通知／履歴まで一貫して連動する形に仕上げてください。